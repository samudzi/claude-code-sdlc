#!/bin/bash
# Global pre-commit hook: runs linting based on project type
# Chains to local hooks if they exist

set -e

# Chain to local .git/hooks/pre-commit if it exists
if [[ -x ".git/hooks/pre-commit" ]]; then
    .git/hooks/pre-commit "$@"
    exit $?
fi

# Check if project has pre-commit framework - if so, it handles its own hooks
if [[ -f ".pre-commit-config.yaml" ]] || \
   [[ -f ".pre-commit-config.yml" ]] || \
   [[ -d ".husky" ]] || \
   [[ -f ".huskyrc" ]] || \
   [[ -f ".huskyrc.json" ]] || \
   [[ -f "lefthook.yml" ]] || \
   [[ -f ".lefthook.yml" ]]; then
    # These frameworks install their own hooks - they should be in .git/hooks
    # If we got here, they haven't been installed yet, so just exit
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [[ -z "$STAGED_FILES" ]]; then
    exit 0
fi

# Detect project type and run appropriate linter
LINT_FAILED=0

# JavaScript/TypeScript
if echo "$STAGED_FILES" | grep -qE '\.(js|jsx|ts|tsx)$'; then
    JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)
    if [[ -n "$JS_FILES" ]]; then
        if [[ -f "node_modules/.bin/eslint" ]]; then
            echo "Running ESLint on staged JS/TS files..."
            echo "$JS_FILES" | xargs node_modules/.bin/eslint --fix || LINT_FAILED=1
            echo "$JS_FILES" | xargs git add
        elif command -v eslint &> /dev/null; then
            echo "Running global ESLint on staged JS/TS files..."
            echo "$JS_FILES" | xargs eslint || LINT_FAILED=1
        fi
    fi
fi

# Python
if echo "$STAGED_FILES" | grep -qE '\.py$'; then
    PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' || true)
    if [[ -n "$PY_FILES" ]]; then
        if command -v ruff &> /dev/null; then
            echo "Running Ruff on staged Python files..."
            echo "$PY_FILES" | xargs ruff check --fix || LINT_FAILED=1
            echo "$PY_FILES" | xargs git add
        elif command -v flake8 &> /dev/null; then
            echo "Running Flake8 on staged Python files..."
            echo "$PY_FILES" | xargs flake8 || LINT_FAILED=1
        fi
    fi
fi

# Go
if echo "$STAGED_FILES" | grep -qE '\.go$'; then
    if command -v gofmt &> /dev/null; then
        echo "Running gofmt on staged Go files..."
        GO_FILES=$(echo "$STAGED_FILES" | grep -E '\.go$' || true)
        echo "$GO_FILES" | xargs gofmt -w || LINT_FAILED=1
        echo "$GO_FILES" | xargs git add
    fi
fi

# Rust
if echo "$STAGED_FILES" | grep -qE '\.rs$'; then
    if command -v rustfmt &> /dev/null; then
        echo "Running rustfmt on staged Rust files..."
        RUST_FILES=$(echo "$STAGED_FILES" | grep -E '\.rs$' || true)
        echo "$RUST_FILES" | xargs rustfmt || LINT_FAILED=1
        echo "$RUST_FILES" | xargs git add
    fi
fi

# Shell scripts
if echo "$STAGED_FILES" | grep -qE '\.(sh|bash)$'; then
    SH_FILES=$(echo "$STAGED_FILES" | grep -E '\.(sh|bash)$' || true)
    if [[ -n "$SH_FILES" ]]; then
        if command -v shellcheck &> /dev/null; then
            echo "Running ShellCheck on staged shell scripts..."
            echo "$SH_FILES" | xargs shellcheck || LINT_FAILED=1
        fi
    fi
fi

if [[ $LINT_FAILED -ne 0 ]]; then
    echo "Linting failed. Please fix the issues and try again."
    exit 1
fi

exit 0
